import numpy as np
from scipy.signal import butter, lfilter, freqz
import matplotlib.pyplot as plt


def butter_lowpass(cutoff, fs, order=5):
    nyq = 0.5 * fs
    normal_cutoff = cutoff / nyq
    b, a = butter(order, normal_cutoff, btype='low', analog=False)
    return b, a


def butter_lowpass_filter(data, cutoff, fs, order=5):
    b, a = butter_lowpass(cutoff, fs, order=order)
    y = lfilter(b, a, data)
    return y


# Setting standard filter requirements.
order = 4
fs = 20
cutoff = 2

b, a = butter_lowpass(cutoff, fs, order)

# Plotting the frequency response.
w, h = freqz(b, a, worN=8000)
plt.subplot(2, 1, 1)
plt.plot(0.5*fs*w/np.pi, np.abs(h), 'b')
plt.plot(cutoff, 0.5*np.sqrt(2), 'ko')
plt.axvline(cutoff, color='k')
plt.xlim(0, 0.5*fs)
plt.title("Lowpass Filter Frequency Response")
plt.xlabel('Frequency [Hz]')
plt.grid()


# Creating the data for filteration

t = np.linspace(0, 89, 90)

data = np.array([107.72922051, 105.26087895, 102.12435116, 107.37700018,
                     99.92669958,  99.93981848,  97.70474536, 101.24946332,
                     99.30051463, 102.06468478, 100.03842928,  99.92458754,
                     102.04194395, 101.84299366, 104.00821546, 102.25260756,
                     102.89919691,  99.94687942, 103.28604469, 104.6821285,
                     105.0929017, 106.93578385, 108.14595478,  53.05036016,
                     50.07349883,  45.07211242,  47.40334502,  47.55691903,
                     51.17168667,  44.9000189,  44.04031643,  50.69699165,
                     48.96302225,  46.12123101,  44.47875733,  41.61514183,
                     45.89879372,  50.03370973,  49.98935095,  50.13942033,
                     209.79727075, 215.77731226, 206.98080343, 204.38667313,
                     197.06035949, 197.68307433, 194.98964279, 190.56187739,
                     78.72094762,  80.16378561,  77.14639867,  79.03889544,
                     81.53755559,  76.6390192,  79.10455866,  75.75030694,
                     75.47758156,  79.39652001, 185.38343128, 189.08689658,
                     193.5825826, 190.03578551, 151.21549515, 145.7445739,
                     143.58447796, 137.37782227, 143.4155081, 153.94632766,
                     187.23921477, 174.74050877, 163.47688097, 152.36631313,
                     67.07928222,  65.30059899,  63.14678729,  56.64294292,
                     53.72123028,  54.84726444,  56.19278282,  54.24928689,
                     49.19354736,  47.97625298,  48.66985477,  52.59828734,
                     59.82830869,  57.84177791,  65.74844293,  67.238899,
                     95.50458224,  91.57499814])

# Filtering and plotting
y = butter_lowpass_filter(data, cutoff, fs, order)

plt.subplot(2, 1, 2)
plt.plot(t, data, 'b-', label='data')
plt.plot(t, y, 'g-', linewidth=2, label='filtered data')
plt.xlabel('Angle [°]')
plt.grid()
plt.legend()

plt.subplots_adjust(hspace=0.35)
plt.show()
#jeu de données exemple issue de display_lidar.py
# array([107.72922051, 105.26087895, 102.12435116, 107.37700018,
#        99.92669958,  99.93981848,  97.70474536, 101.24946332,
#        99.30051463, 102.06468478, 100.03842928,  99.92458754,
#        102.04194395, 101.84299366, 104.00821546, 102.25260756,
#        102.89919691,  99.94687942, 103.28604469, 104.6821285,
#        105.0929017, 106.93578385, 108.14595478,  53.05036016,
#        50.07349883,  45.07211242,  47.40334502,  47.55691903,
#        51.17168667,  44.9000189,  44.04031643,  50.69699165,
#        48.96302225,  46.12123101,  44.47875733,  41.61514183,
#        45.89879372,  50.03370973,  49.98935095,  50.13942033,
#        209.79727075, 215.77731226, 206.98080343, 204.38667313,
#        197.06035949, 197.68307433, 194.98964279, 190.56187739,
#        78.72094762,  80.16378561,  77.14639867,  79.03889544,
#        81.53755559,  76.6390192,  79.10455866,  75.75030694,
#        75.47758156,  79.39652001, 185.38343128, 189.08689658,
#        193.5825826, 190.03578551, 151.21549515, 145.7445739,
#        143.58447796, 137.37782227, 143.4155081, 153.94632766,
#        187.23921477, 174.74050877, 163.47688097, 152.36631313,
#        67.07928222,  65.30059899,  63.14678729,  56.64294292,
#        53.72123028,  54.84726444,  56.19278282,  54.24928689,
#        49.19354736,  47.97625298,  48.66985477,  52.59828734,
#        59.82830869,  57.84177791,  65.74844293,  67.238899,
#        95.50458224,  91.57499814])
